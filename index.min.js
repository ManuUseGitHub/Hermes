const Discord=require("discord.js"),disbut=require("discord-buttons"),{MessageButton,MessageActionRow}=disbut,{Roles,_Guild}=require("./ZiQuatorze/Resources"),{arr_diff,posponeTimeout,packetClosure}=require("./utilities.js"),{getHelloLocalizedDescription,getHelloLocalizedAcceptation}=require("./greetings.js"),Adhesion=require("./ZiQuatorze/Adhesion"),Users=require("./ZiQuatorze/Users"),env=require("dotenv").config();console.log(`Environment : ${process.env.NODE_ENV}`);const client=new Discord.Client;disbut(client),client.login(process.env.BOT_TOKEN);const Resources={client:client,roles:Roles,guild:_Guild};Adhesion.init(Resources),Users.init(Resources);const POOL_TIME=process.env.POOL_TIME,activity={userPool:{},buttonPool:{}};client.on("ready",()=>{console.log("Bot is ready")});const buildRoleIDList=(e,o=!0)=>{const i=[];return e.roles.cache.each(({id:e,name:s})=>{o?i.push(e):i.push(s)}),i};function getLanguageMember(e,s){return{oldLangRoles:Users.getLanguagesOfMember(e),newLangRoles:Users.getLanguagesOfMember(s)}}function removeValidRoles(e){e.roles.set([],"Is not a valid member anymore")}const discardUser=e=>{const s=Users.getUserFromItsId(e);s.roles.set([]),setTimeout(()=>{Adhesion.updatePendingList()},1e3)},onListedRolesDo=(e,s)=>{var o,i=/^.*-(\[(?:.+[,])*,?\])-to-\d+/.exec(e.id);const t=/([^\\[,]+),/g;for(;o=t.exec(i[1]);)o.index===t.lastIndex&&t.lastIndex++,s(Roles[o[1]].id)},addRole=(e,s)=>{const o=Users.getUserFromItsId(e);onListedRolesDo(s,e=>{o.roles.add(e)}),setTimeout(()=>{Adhesion.updatePendingList()},2e3)},removeRoles=(e,s)=>{const o=Users.getUserFromItsId(e);onListedRolesDo(s,e=>{o.roles.remove(e)})},poolActionForId=(e,s,o)=>{null!=e[s]?postponeReactionClosure(s,e):(e[s]={timer:setTimeout(()=>{delete e[s]},Number.parseInt(POOL_TIME))},o())};client.on("clickButton",async e=>{var s=/^((?:-?[a-zA-Z\d])+).*-(\d+)/.exec(e.id);const o=s[1],i=s[2];poolActionForId(activity.buttonPool,i,()=>{switch(o.toLowerCase()){case"add-role":addRole(i,e);break;case"remove-role":removeRoles(i,e);break;case"discard-user":discardUser(i)}e.reply.defer()})});const getDiffRoles=(e,s,o=!0)=>arr_diff(e.roles.cache.map(({name:e,id:s})=>`${o?s:e}`),s.roles.cache.map(({name:e,id:s})=>`${o?s:e}`)),postponeReactionClosure=(e,s)=>{var o=s[e];posponeTimeout(o,POOL_TIME,{cb:()=>{delete s[e]},params:[]})},validateNewUser=e=>{const{diff:s,newRIds:o,oldRIDs:i,newLangRoles:t,member:n}=e;if(s[0]===Roles.V_R.id&&o.length>i.length){e=/^M-([a-z]{0,3})$/.exec(t[0]);if(e){e={fr:Roles.V_FR_R.id,jp:Roles.V_JP_R.id,id:Roles.V_ID_R.id,en:Roles.V_EN_R.id}[e[1]];n._new.roles.add(e,"language validation defined");e=getHelloLocalizedAcceptation(t[0]);const l=client.users.cache.get(n._new.user.id);e=(new Discord.MessageEmbed).setDescription(e);l.send(e)}}};client.on("messageReactionAdd",(e,s)=>{s.id===_Guild.U_MR_TRANSLATE.id&&e.users.remove(s.id)}),client.on("raw",i=>{if(["MESSAGE_REACTION_ADD","MESSAGE_REACTION_REMOVE"].includes(i.t)){const e=client.channels.cache.get(i.d.channel_id);e.messages.cache.has(i.d.message_id)||e.messages.fetch(i.d.message_id).then(e=>{var s=i.d.emoji.id?`${i.d.emoji.name}:${i.d.emoji.id}`:i.d.emoji.name;const o=e.reactions.cache.get(s);o&&o.users.cache.set(i.d.user_id,client.users.cache.get(i.d.user_id)),"MESSAGE_REACTION_ADD"===i.t&&client.emit("messageReactionAdd",o,client.users.cache.get(i.d.user_id)),"MESSAGE_REACTION_REMOVE"===i.t&&client.emit("messageReactionRemove",o,client.users.cache.get(i.d.user_id))})}}),client.on("guildMemberUpdate",(r,a)=>{let c=getDiffRoles(r,a,!0);poolActionForId(activity.userPool,r.id,()=>{var e=buildRoleIDList(r),s=buildRoleIDList(a);let o=a.roles.cache.map(({id:e})=>`${e}`);var{oldLangRoles:i,newLangRoles:t}=getLanguageMember(r,a);if(1<t.length){const l=arr_diff(i,t);var n=a.roles.cache.filter(({name:e})=>e==l).map(e=>e.id);n&&a.roles.remove(n)}0==t.length&&i.length>t.length?(a.roles.remove([Roles.PENDING_R.id,Roles.MEMBER_R.id],"Is not a member anymore"),removeValidRoles(a)):i.length<t.length&&(a.roles.add(Roles.MEMBER_R.id,"Is a member"),o.push(Roles.MEMBER_R.id));i=s.length<e.length&&!o.includes(Roles.MEMBER_R.id);if(o.includes(Roles.V_R.id)||i)a.roles.remove(Roles.PENDING_R.id,"Has not the pending role"),i&&(a.roles.set([],"is not a member anymore"),removeValidRoles(a));else if(s.length>e.length){a.roles.cache.map(({name:e})=>`${e}`);if(o.includes(Roles.MEMBER_R.id)&&!o.includes(Roles.V_R.id)&&t.length<2){i=getHelloLocalizedDescription(t[0]);if("NOT TRANSLATABLE"!=i){a.roles.add(Roles.PENDING_R.id,"Has the pending role");const d=client.users.cache.get(a.user.id);i=(new Discord.MessageEmbed).setDescription(i);d.send(i),setTimeout(()=>{Adhesion.updatePendingList()},1e3)}}}c[0]===Roles.V_R.id&&s.length>e.length&&validateNewUser({diff:c,newRIds:s,oldRIDs:e,newLangRoles:t,member:{_new:a,old:r}})})}),client.on("message",e=>{if("z14 all"==e.content)Adhesion.updatePendingList(),e.delete();else if(/^z14 all .*/.test(e.content)){var s=/^z14 all[^\d]*([0-9]+)[^\d]*/.exec(e);const o=client.guilds.cache.get(_Guild.G_ID.id);s=o.roles.cache.get(s[1]);Adhesion.updatePendingList(s),e.delete()}});
//# sourceMappingURL=index.min.js.map