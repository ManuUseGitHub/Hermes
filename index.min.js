const env=require("dotenv").config(),Discord=require("discord.js"),MessageEmbed=Discord["MessageEmbed"],disbut=require("discord-buttons"),sem=require("./ZiQuatorze/Semaphored"),Internalize=require("./internalization"),{MessageButton,MessageActionRow}=disbut,{Roles,_Guild}=require("./ZiQuatorze/Resources"),{arr_diff,posponeTimeout,packetClosure}=require("./utilities.js"),Adhesion=require("./ZiQuatorze/Adhesion"),Users=require("./ZiQuatorze/Users"),page=require("./page"),internalize=new Internalize(Users);console.log(`Environment : ${process.env.NODE_ENV}`);const client=new Discord.Client;disbut(client),client.login(process.env.BOT_TOKEN);const Resources={client:client,roles:Roles,guild:_Guild};Adhesion.init(Resources),Users.init(Resources),internalize.init(Resources);const POOL_TIME=process.env.POOL_TIME,activity={userPool:{},buttonPool:{}};client.on("ready",()=>{console.log("Bot is ready")});const buildRoleIDList=(e,i=!0)=>{const n=[];return e.roles.cache.each(({id:e,name:s})=>{i?n.push(e):n.push(s)}),n};function getLanguageMember(e,s){return{oldLangRoles:Users.getLanguagesOfMember(e),newLangRoles:Users.getLanguagesOfMember(s)}}function removeValidRoles(e){e.roles.set([],"Is not a valid member anymore")}const discardUser=e=>{const s=Users.getUserFromItsId(e);s.roles.set([]),setTimeout(()=>{Adhesion.updatePendingList()},1e3)},onListedRolesDo=(e,s)=>{var i,n=/^.*-(\[(?:.+[,])*,?\])-to-\d+/.exec(e.id);const t=/([^\\[,]+),/g;for(;i=t.exec(n[1]);)i.index===t.lastIndex&&t.lastIndex++,s(Roles[i[1]].id)},addRole=(e,s)=>{const i=Users.getUserFromItsId(e);onListedRolesDo(s,e=>{i.roles.add(e)}),setTimeout(()=>{Adhesion.updatePendingList()},2e3)},removeRoles=(e,s)=>{const i=Users.getUserFromItsId(e);onListedRolesDo(s,e=>{i.roles.remove(e)})};client.on("clickButton",async e=>{var s=/^((?:-?[a-zA-Z\d])+).*-(\d+)/.exec(e.id);const i=s[1],n=s[2];sem.poolActionForId(activity.buttonPool,n,()=>{switch(i.toLowerCase()){case"add-role":addRole(n,e);break;case"remove-role":removeRoles(n,e);break;case"discard-user":discardUser(n)}e.reply.defer()})});const getDiffRoles=(e,s,i=!0)=>arr_diff(e.roles.cache.map(({name:e,id:s})=>`${i?s:e}`),s.roles.cache.map(({name:e,id:s})=>`${i?s:e}`)),validateNewUser=e=>{const{diff:s,newRIds:i,oldRIDs:n,newLangRoles:t,member:o}=e;if(s[0]===Roles.V_R.id&&i.length>n.length){e=/^M-([a-z]{0,3})$/.exec(t[0]);if(e){e={fr:Roles.V_FR_R.id,jp:Roles.V_JP_R.id,id:Roles.V_ID_R.id,en:Roles.V_EN_R.id}[e[1]];o._new.roles.add(e,"language validation defined");e=internalize.tu("accepted_adhesion",o._new);const r=client.users.cache.get(o._new.user.id);e=(new Discord.MessageEmbed).setDescription(e);r.send(e)}}};client.on("messageReactionAdd",(e,s)=>{s.id===_Guild.U_MR_TRANSLATE.id&&e.users.remove(s.id)}),client.on("raw",n=>{if(["MESSAGE_REACTION_ADD","MESSAGE_REACTION_REMOVE"].includes(n.t)){const e=client.channels.cache.get(n.d.channel_id);e.messages.cache.has(n.d.message_id)||e.messages.fetch(n.d.message_id).then(e=>{var s=n.d.emoji.id?`${n.d.emoji.name}:${n.d.emoji.id}`:n.d.emoji.name;const i=e.reactions.cache.get(s);i&&i.users.cache.set(n.d.user_id,client.users.cache.get(n.d.user_id)),"MESSAGE_REACTION_ADD"===n.t&&client.emit("messageReactionAdd",i,client.users.cache.get(n.d.user_id)),"MESSAGE_REACTION_REMOVE"===n.t&&client.emit("messageReactionRemove",i,client.users.cache.get(n.d.user_id))})}}),client.on("guildMemberUpdate",(l,a)=>{let c=getDiffRoles(l,a,!0);sem.poolActionForId(activity.userPool,l.id,()=>{var e=buildRoleIDList(l),s=buildRoleIDList(a);let i=a.roles.cache.map(({id:e})=>`${e}`);var{oldLangRoles:n,newLangRoles:t}=getLanguageMember(l,a);if(1<t.length){const r=arr_diff(n,t);var o=a.roles.cache.filter(({name:e})=>e==r).map(e=>e.id);o&&a.roles.remove(o)}0==t.length&&n.length>t.length?(a.roles.remove([Roles.PENDING_R.id,Roles.MEMBER_R.id],"Is not a member anymore"),removeValidRoles(a)):n.length<t.length&&(a.roles.add(Roles.MEMBER_R.id,"Is a member"),i.push(Roles.MEMBER_R.id));n=s.length<e.length&&!i.includes(Roles.MEMBER_R.id);if(i.includes(Roles.V_R.id)||n)a.roles.remove(Roles.PENDING_R.id,"Has not the pending role"),n&&(a.roles.set([],"is not a member anymore"),removeValidRoles(a));else if(s.length>e.length){a.roles.cache.map(({name:e})=>`${e}`);if(i.includes(Roles.MEMBER_R.id)&&!i.includes(Roles.V_R.id)&&t.length<2){n=internalize.tu("greetings",a);if(n){a.roles.add(Roles.PENDING_R.id,"Has the pending role");const d=client.users.cache.get(a.user.id);n=(new Discord.MessageEmbed).setDescription(n);d.send(n),setTimeout(()=>{Adhesion.updatePendingList()},1e3)}}}c[0]===Roles.V_R.id&&s.length>e.length&&validateNewUser({diff:c,newRIds:s,oldRIDs:e,newLangRoles:t,member:{_new:a,old:l}})})}),client.on("message",e=>{if("!help"!=e.content){if("z13"==e.content){e.delete();e.channel.messages.fetch({limit:2}).then(e=>{e.map(e=>{e.embeds.length&&/.+\s(irregular verbs)/.test(e.embeds[0].title)&&console.log(e.id,e.content,e.embeds)})});var s=require("./ZiQuatorze/assets/Verbs/commons.json").verbs;const u=(s,e,i=16,n=[],t=0)=>{let o=t,r=i;var d=s.length;if(o+i>d&&(r=d%i),!s[o])return n;const l=new MessageEmbed;for(e(l);o<d;o+=2){var a=o+1,c=s[o];let e=s[a];s[a]||(e={inf:"​",part:"​",pret:"​"}),l.addFields({name:c.inf,value:e.inf,inline:!0},{name:c.pret,value:e.pret,inline:!0},{name:c.part,value:e.part,inline:!0})}return n.push(l),u(s,e,r,n,t+i)};s=u(s,e=>{e.setColor("#0099ff").setTitle("Common irregular verbs").setDescription("Some title").setFooter("Some footer text here","https://i.imgur.com/AfFp7pu.png").setTimestamp()},14);page.main({embeds:s,message:e})}if("z14 all"==e.content)e.channel.id!=_Guild.C_NEW_COMMERS.id&&(i=internalize.tuid("wrong_channel_for_command",e.author.id,[e.author.id,_Guild.C_NEW_COMMERS.id]),e.channel.send(i)),Adhesion.updatePendingList(),e.delete();else if(/^z14 all .*/.test(e.content)){var i=/^z14 all[^\d]*([0-9]+)[^\d]*/.exec(e);const n=client.guilds.cache.get(_Guild.G_ID.id);i=n.roles.cache.get(i[1]);Adhesion.updatePendingList(i),e.delete()}}});
//# sourceMappingURL=index.min.js.map