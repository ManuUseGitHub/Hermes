const env=require("dotenv").config(),Discord=require("discord.js"),disbut=require("discord-buttons"),Internalize=require("./internalization"),{MessageButton,MessageActionRow}=disbut,{Roles,_Guild}=require("./ZiQuatorze/Resources"),{arr_diff,posponeTimeout,packetClosure}=require("./utilities.js"),{getHelloLocalizedDescription,getHelloLocalizedAcceptation}=require("./greetings.js"),Adhesion=require("./ZiQuatorze/Adhesion"),Users=require("./ZiQuatorze/Users"),internalize=new Internalize(Users);console.log(`Environment : ${process.env.NODE_ENV}`);const client=new Discord.Client;disbut(client),client.login(process.env.BOT_TOKEN);const Resources={client:client,roles:Roles,guild:_Guild};Adhesion.init(Resources),Users.init(Resources),internalize.init(Resources);const POOL_TIME=process.env.POOL_TIME,activity={userPool:{},buttonPool:{}};client.on("ready",()=>{console.log("Bot is ready")});const buildRoleIDList=(e,i=!0)=>{const o=[];return e.roles.cache.each(({id:e,name:s})=>{i?o.push(e):o.push(s)}),o};function getLanguageMember(e,s){return{oldLangRoles:Users.getLanguagesOfMember(e),newLangRoles:Users.getLanguagesOfMember(s)}}function removeValidRoles(e){e.roles.set([],"Is not a valid member anymore")}const discardUser=e=>{const s=Users.getUserFromItsId(e);s.roles.set([]),setTimeout(()=>{Adhesion.updatePendingList()},1e3)},onListedRolesDo=(e,s)=>{var i,o=/^.*-(\[(?:.+[,])*,?\])-to-\d+/.exec(e.id);const n=/([^\\[,]+),/g;for(;i=n.exec(o[1]);)i.index===n.lastIndex&&n.lastIndex++,s(Roles[i[1]].id)},addRole=(e,s)=>{const i=Users.getUserFromItsId(e);onListedRolesDo(s,e=>{i.roles.add(e)}),setTimeout(()=>{Adhesion.updatePendingList()},2e3)},removeRoles=(e,s)=>{const i=Users.getUserFromItsId(e);onListedRolesDo(s,e=>{i.roles.remove(e)})},poolActionForId=(e,s,i)=>{null!=e[s]?postponeReactionClosure(s,e):(e[s]={timer:setTimeout(()=>{delete e[s]},Number.parseInt(POOL_TIME))},i())};client.on("clickButton",async e=>{var s=/^((?:-?[a-zA-Z\d])+).*-(\d+)/.exec(e.id);const i=s[1],o=s[2];poolActionForId(activity.buttonPool,o,()=>{switch(i.toLowerCase()){case"add-role":addRole(o,e);break;case"remove-role":removeRoles(o,e);break;case"discard-user":discardUser(o)}e.reply.defer()})});const getDiffRoles=(e,s,i=!0)=>arr_diff(e.roles.cache.map(({name:e,id:s})=>`${i?s:e}`),s.roles.cache.map(({name:e,id:s})=>`${i?s:e}`)),postponeReactionClosure=(e,s)=>{var i=s[e];posponeTimeout(i,POOL_TIME,{cb:()=>{delete s[e]},params:[]})},validateNewUser=e=>{const{diff:s,newRIds:i,oldRIDs:o,newLangRoles:n,member:t}=e;if(s[0]===Roles.V_R.id&&i.length>o.length){e=/^M-([a-z]{0,3})$/.exec(n[0]);if(e){e={fr:Roles.V_FR_R.id,jp:Roles.V_JP_R.id,id:Roles.V_ID_R.id,en:Roles.V_EN_R.id}[e[1]];t._new.roles.add(e,"language validation defined");e=internalize.tu("accepted_adhesion",t._new);const d=client.users.cache.get(t._new.user.id);e=(new Discord.MessageEmbed).setDescription(e);d.send(e)}}};client.on("messageReactionAdd",(e,s)=>{s.id===_Guild.U_MR_TRANSLATE.id&&e.users.remove(s.id)}),client.on("raw",o=>{if(["MESSAGE_REACTION_ADD","MESSAGE_REACTION_REMOVE"].includes(o.t)){const e=client.channels.cache.get(o.d.channel_id);e.messages.cache.has(o.d.message_id)||e.messages.fetch(o.d.message_id).then(e=>{var s=o.d.emoji.id?`${o.d.emoji.name}:${o.d.emoji.id}`:o.d.emoji.name;const i=e.reactions.cache.get(s);i&&i.users.cache.set(o.d.user_id,client.users.cache.get(o.d.user_id)),"MESSAGE_REACTION_ADD"===o.t&&client.emit("messageReactionAdd",i,client.users.cache.get(o.d.user_id)),"MESSAGE_REACTION_REMOVE"===o.t&&client.emit("messageReactionRemove",i,client.users.cache.get(o.d.user_id))})}}),client.on("guildMemberUpdate",(r,a)=>{let c=getDiffRoles(r,a,!0);poolActionForId(activity.userPool,r.id,()=>{var e=buildRoleIDList(r),s=buildRoleIDList(a);let i=a.roles.cache.map(({id:e})=>`${e}`);var{oldLangRoles:o,newLangRoles:n}=getLanguageMember(r,a);if(1<n.length){const d=arr_diff(o,n);var t=a.roles.cache.filter(({name:e})=>e==d).map(e=>e.id);t&&a.roles.remove(t)}0==n.length&&o.length>n.length?(a.roles.remove([Roles.PENDING_R.id,Roles.MEMBER_R.id],"Is not a member anymore"),removeValidRoles(a)):o.length<n.length&&(a.roles.add(Roles.MEMBER_R.id,"Is a member"),i.push(Roles.MEMBER_R.id));o=s.length<e.length&&!i.includes(Roles.MEMBER_R.id);if(i.includes(Roles.V_R.id)||o)a.roles.remove(Roles.PENDING_R.id,"Has not the pending role"),o&&(a.roles.set([],"is not a member anymore"),removeValidRoles(a));else if(s.length>e.length){a.roles.cache.map(({name:e})=>`${e}`);if(i.includes(Roles.MEMBER_R.id)&&!i.includes(Roles.V_R.id)&&n.length<2){o=internalize.tu("greetings",a);if(o){a.roles.add(Roles.PENDING_R.id,"Has the pending role");const l=client.users.cache.get(a.user.id);o=(new Discord.MessageEmbed).setDescription(o);l.send(o),setTimeout(()=>{Adhesion.updatePendingList()},1e3)}}}c[0]===Roles.V_R.id&&s.length>e.length&&validateNewUser({diff:c,newRIds:s,oldRIDs:e,newLangRoles:n,member:{_new:a,old:r}})})}),client.on("message",e=>{if("!help"!=e.content)if("z14 all"==e.content)e.channel.id!=_Guild.C_NEW_COMMERS.id&&(s=internalize.tuid("wrong_channel_for_command",e.author.id,[e.author.id,_Guild.C_NEW_COMMERS.id]),e.channel.send(s)),Adhesion.updatePendingList(),e.delete();else if(/^z14 all .*/.test(e.content)){var s=/^z14 all[^\d]*([0-9]+)[^\d]*/.exec(e);const i=client.guilds.cache.get(_Guild.G_ID.id);s=i.roles.cache.get(s[1]);Adhesion.updatePendingList(s),e.delete()}});
//# sourceMappingURL=index.min.js.map