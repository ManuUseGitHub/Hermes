const Discord=require("discord.js"),disbut=require("discord-buttons"),{MessageButton,MessageActionRow}=disbut,{Roles,_Guild}=require("./rousources"),{arr_diff,posponeTimeout,packetClosure}=require("./utilities.js"),{getHelloLocalizedDescription,getHelloLocalizedAcceptation}=require("./greetings.js"),env=require("dotenv").config();env.error,console.log(`Environment : ${process.env.NODE_ENV}`);const client=new Discord.Client;disbut(client),client.login(process.env.BOT_TOKEN);const POOL_TIME=process.env.POOL_TIME,activity={pool1:[],pool2:[],pool3:{},buttonPool:{}},pendings={pool:{}};client.on("ready",()=>{console.log("Bot is ready")}),client.login(process.env.BOT_TOKEN);const buildRoleIDList=(e,o=!0)=>{const t=[];return e.roles.cache.each(({id:e,name:s})=>{o?t.push(e):t.push(s)}),t},signEmbeded=(e,s)=>{const o=getUserFromItsId(s).user;s=o.avatarURL();null===s?e.setAuthor(`${o.username}`):e.setAuthor(`${o.username}`,`${s}`)};function getLanguageMember(e,s){const o=e.roles.cache.map(({name:e})=>`${e}`);e=o.filter(e=>/^M-[a-z]{0,3}$/.test(e));const t=s.roles.cache.map(({name:e})=>`${e}`);return{oldLangRoles:e,newLangRoles:t.filter(e=>/^M-[a-z]{0,3}$/.test(e))}}function removeValidRoles(e){e.roles.set([],"Is not a valid member anymore")}const discardUser=e=>{pendings.pool[e]&&(pendings.pool[e].roles.remove([Roles.MEMBER_R.id,Roles.PENDING_R.id]),delete pendings.pool[e])},onListedRolesDo=(e,s)=>{var o,t=/^.*-(\[(?:.+[,])*,?\])-to-\d+/.exec(e.id);const i=/([^\[,]+),/g;for(;o=i.exec(t[1]);)o.index===i.lastIndex&&i.lastIndex++,s(Roles[o[1]])},getUserFromItsId=s=>{const e=client.guilds.cache.get(_Guild.G_ID.id);return e.members.cache.filter(e=>{if(e.id==s)return!0}).get(s)},addRole=(e,s)=>{const o=getUserFromItsId(e);onListedRolesDo(s,e=>{o.roles.add(e)}),setTimeout(()=>{updatePendingList()},2e3)},removeRoles=(e,s)=>{const o=getUserFromItsId(e);onListedRolesDo(s,e=>{o.roles.remove(e)})},poolActionForId=(e,s,o)=>{null!=e[s]?postponeReactionClosure(s,e):(e[s]={timer:setTimeout(()=>{delete e[s]},POOL_TIME)},o())};client.on("clickButton",async e=>{var s=/^((?:-?[a-zA-Z\d])+).*-(\d+)/.exec(e.id);const o=s[1],t=s[2];poolActionForId(activity.buttonPool,t,()=>{switch(o.toLowerCase()){case"add-role":addRole(t,e);break;case"remove-role":removeRoles(t,e);break;case"discard-user":discardUser(t)}e.reply.defer()})});const getDiffRoles=(e,s,o=!0)=>arr_diff(e.roles.cache.map(({name:e,id:s})=>`${o?s:e}`),s.roles.cache.map(({name:e,id:s})=>`${o?s:e}`)),postponeReactionClosure=(e,s)=>{var o=s[e];posponeTimeout(o,POOL_TIME,{cb:()=>{delete s[e]},params:[]})},validateNewUser=e=>{const{diff:s,newRIds:o,oldRIDs:t,newLangRoles:i,member:n}=e;if(s[0]===Roles.V_R.id&&o.length>t.length){e=/^M-([a-z]{0,3})$/.exec(i[0]);if(e){e=("fr"==e[1]?Roles.V_FR_R:"jp"==e[1]?Roles.V_JP_R:"id"==e[1]?Roles.V_ID_R:Roles.V_EN_R).id;n._new.roles.add(e,"language validation defined");e=getHelloLocalizedAcceptation(i[0]);const l=client.users.cache.get(n._new.user.id);e=(new Discord.MessageEmbed).setDescription(e);l.send(e)}}};client.on("messageReactionAdd",(e,s)=>{s.id===_Guild.U_MR_TRANSLATE.id&&e.users.remove(s.id)}),client.on("raw",t=>{if(["MESSAGE_REACTION_ADD","MESSAGE_REACTION_REMOVE"].includes(t.t)){const e=client.channels.cache.get(t.d.channel_id);e.messages.cache.has(t.d.message_id)||e.messages.fetch(t.d.message_id).then(e=>{var s=t.d.emoji.id?`${t.d.emoji.name}:${t.d.emoji.id}`:t.d.emoji.name;const o=e.reactions.cache.get(s);o&&o.users.cache.set(t.d.user_id,client.users.cache.get(t.d.user_id)),"MESSAGE_REACTION_ADD"===t.t&&client.emit("messageReactionAdd",o,client.users.cache.get(t.d.user_id)),"MESSAGE_REACTION_REMOVE"===t.t&&client.emit("messageReactionRemove",o,client.users.cache.get(t.d.user_id))})}}),client.on("guildMemberUpdate",(r,a)=>{let c=getDiffRoles(r,a,!0);poolActionForId(activity.pool3,r.id,()=>{var e=buildRoleIDList(r),s=buildRoleIDList(a);let o=a.roles.cache.map(({id:e})=>`${e}`);var{oldLangRoles:t,newLangRoles:i}=getLanguageMember(r,a);if(1<i.length){const l=arr_diff(t,i);var n=a.roles.cache.filter(({name:e})=>e==l).map(e=>e.id);n&&a.roles.remove(n)}0==i.length&&t.length>i.length?(a.roles.remove([Roles.PENDING_R.id,Roles.MEMBER_R.id],"Is not a member anymore"),removeValidRoles(a)):t.length<i.length&&(a.roles.add(Roles.MEMBER_R.id,"Is a member"),o.push(Roles.MEMBER_R.id));t=s.length<e.length&&!o.includes(Roles.MEMBER_R.id);if(o.includes(Roles.V_R.id)||t)a.roles.remove(Roles.PENDING_R.id,"Has not the pending role"),t&&(a.roles.set([],"is not a member anymore"),removeValidRoles(a));else if(s.length>e.length){a.roles.cache.map(({name:e})=>`${e}`);if(o.includes(Roles.MEMBER_R.id)&&!o.includes(Roles.V_R.id)&&i.length<2){t=getHelloLocalizedDescription(i[0]);if("NOT TRANSLATABLE"!=t){a.roles.add(Roles.PENDING_R.id,"Has the pending role");const d=client.users.cache.get(a.user.id);t=(new Discord.MessageEmbed).setDescription(t);d.send(t),updatePendingList()}}}c[0]===Roles.V_R.id&&s.length>e.length&&validateNewUser({diff:c,newRIds:s,oldRIDs:e,newLangRoles:i,member:{_new:a,old:r}})})});const createMembershipManagedButtons=e=>({type:1,components:[{type:2,label:"[x]",style:4,custom_id:`discard-User-${e.user.id}`},{type:2,label:`[+] ${e.user.username}`,style:3,custom_id:`add-role-[V_R,]-to-${e.user.id}`}]}),updatePendingList=()=>{const e=client.guilds.cache.get(_Guild.G_ID.id),s=e.members.cache.map(e=>({roles:{list:e._roles,manager:e.roles},user:e.user})).filter(e=>{let s=!1;return e.roles.list.forEach(e=>{e==Roles.PENDING_R.id&&(s=!0)}),s});let o=new Discord.MessageEmbed;o.description=`there are ${s.length}`,o.setTimestamp(),signEmbeded(o,_Guild.U_MY_BOT.id);Roles.PENDING_R.id;const t=[];let i=e.channels.cache.get(_Guild.C_NEW_COMMERS.id);i.messages.fetch(_Guild.M_PENDING_COUNT.id).then(e=>{s.forEach(e=>{t.push(createMembershipManagedButtons(e))}),e.edit(o,{components:t})})};client.on("message",e=>{"z14 all"==e.content&&(updatePendingList(),e.delete())});
//# sourceMappingURL=app.min.js.map